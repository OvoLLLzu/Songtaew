<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Songtaew route helper — Pattaya</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"  />
  <style>
    html,body,#map{ height:100%; margin:0; padding:0; }
    #panel{ position:absolute; top:10px; left:10px; z-index:1000; background:#fff; padding:10px; border-radius:6px; box-shadow:0 2px 8px rgba(0,0,0,0.2); font-family:Arial, sans-serif; }
    #panel h3{ margin:0 0 6px 0; }
    #routesLegend{ max-height:120px; overflow:auto; margin-top:6px; }
    button{ margin-right:6px; }
  </style>
</head>
<body>
<div id="panel">
  <h3>Songtaew route helper — Паттайя</h3>
  <div>Кликни на карту: первый клик — <b>где ты</b>, второй — <b>куда хочешь</b>.</div>
  <div style="margin-top:6px;">
    <button id="resetBtn">Сбросить</button>
    <button id="fitBtn">Показать всё</button>
  </div>
  <div id="info" style="margin-top:8px;font-size:13px"></div>
  <div id="routesLegend"></div>
  <div style="margin-top:6px;font-size:12px;color:#555">Алгоритм: выбирается маршрут с минимальной суммой пешеходных участков до/от маршрута. Затем рисуется пешеходный путь к началу маршрута, отрезок маршрута и пешком до точки назначения.</div>
</div>
<div id="map"></div>

<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
<script>
// --- Инициализация карты ---
const map = L.map('map').setView([12.9236, 100.8825], 13); // Pattaya
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ maxZoom:19, attribution:'© OpenStreetMap contributors' }).addTo(map);

// --- Примерные маршруты сонгтео в Паттайе (упрощённые полилинии) ---
// Координаты в формате [lng, lat] для удобства работы с turf (geojson: [lon, lat])
const ROUTES = [
  {
    id: 'beach-loop',
    name: 'Beach Road — Second Road (Центр)',
    color: '#1f78b4',
    coords: [
      [100.8790,12.9391], // north Dolphin area
      [100.8810,12.9345],
      [100.8830,12.9280],
      [100.8835,12.9200],
      [100.8840,12.9140],
      [100.8828,12.9085],
      [100.8800,12.9028], // near walking street
      [100.8790,12.8950],
      [100.8785,12.9010],
      [100.8765,12.9090],
      [100.8740,12.9180],
      [100.8755,12.9280],
      [100.8785,12.9350],
      [100.8790,12.9391]
    ]
  },
  {
    id: 'naklua',
    name: 'Dolphin → Naklua (Наклуа)',
    color: '#33a02c',
    coords: [
      [100.8790,12.9391],
      [100.8805,12.9430],
      [100.8828,12.9480],
      [100.8870,12.9520],
      [100.8920,12.9550]
    ]
  },
  {
    id: 'jomtien',
    name: 'Thappraya → Jomtien (Джомтьен)',
    color: '#e31a1c',
    coords: [
      [100.8830,12.9280],
      [100.8850,12.9200],
      [100.8880,12.9120],
      [100.8920,12.9000],
      [100.8960,12.8915]
    ]
  },
  {
    id: 'sukhumvit',
    name: 'Dolphin → Terminal 21 → Sukhumvit',
    color: '#ff7f00',
    coords: [
      [100.8790,12.9391],
      [100.8880,12.9350],
      [100.8970,12.9300],
      [100.9040,12.9250]
    ]
  }
];

// Добавим визуализацию маршрутов
const routesLayerGroup = L.layerGroup().addTo(map);
ROUTES.forEach(r => {
  const latlngs = r.coords.map(c => [c[1], c[0]]);
  r._poly = L.polyline(latlngs, {color: r.color, weight:4, opacity:0.7}).addTo(routesLayerGroup);
});

// Легенда
const legend = document.getElementById('routesLegend');
ROUTES.forEach(r => {
  const el = document.createElement('div');
  el.innerHTML = `<span style="display:inline-block;width:12px;height:12px;background:${r.color};margin-right:6px;border-radius:3px;"></span>${r.name}`;
  legend.appendChild(el);
});

// --- Взаимодействие: клики для постановки маркеров ---
let origin = null, dest = null;
let originMarker=null, destMarker=null;
let resultLayers = L.layerGroup().addTo(map);

map.on('click', e => {
  if (!origin) {
    origin = [e.latlng.lng, e.latlng.lat];
    originMarker = L.marker([origin[1], origin[0]], {title:'Origin'}).addTo(map).bindPopup('Отсюда (origin)').openPopup();
    updateInfo('Отметил местоположение. Теперь кликни, куда хочешь попасть.');
  } else if (!dest) {
    dest = [e.latlng.lng, e.latlng.lat];
    destMarker = L.marker([dest[1], dest[0]], {title:'Destination'}).addTo(map).bindPopup('Сюда (destination)').openPopup();
    updateInfo('Отмечено место назначения. Ищу подходящий маршрут...');
    computeBestRoute();
  }
});

function updateInfo(text){ document.getElementById('info').innerText = text; }

// --- Логика выбора маршрута ---
function computeBestRoute(){
  resultLayers.clearLayers();
  if (!origin || !dest) return;

  const originPt = turf.point(origin);
  const destPt = turf.point(dest);

  const candidates = ROUTES.map(route => {
    const line = turf.lineString(route.coords);
    const nearestToOrigin = turf.nearestPointOnLine(line, originPt, {units:'kilometers'});
    const nearestToDest = turf.nearestPointOnLine(line, destPt, {units:'kilometers'});

    // slice segment along route between these two points
    const p1 = nearestToOrigin.geometry.coordinates;
    const p2 = nearestToDest.geometry.coordinates;
    const slice = turf.lineSlice(turf.point(p1), turf.point(p2), line);
    const routeSegmentLen = turf.length(slice, {units:'kilometers'});

    const walkStart = turf.distance(originPt, turf.point(p1), {units:'kilometers'});
    const walkEnd = turf.distance(destPt, turf.point(p2), {units:'kilometers'});

    // score: минимизируем суммарную пешую дистанцию, потом длину сегмента
    const score = walkStart + walkEnd + routeSegmentLen*0.001; // малый вес для маршрута

    return {
      route, line, nearestToOrigin, nearestToDest, routeSegmentLen, walkStart, walkEnd, score, slice
    };
  });

  candidates.sort((a,b)=> a.score - b.score);
  const best = candidates[0];

  // Отображаем выбранный маршрут и пути
  showResult(best);
}

function showResult(best){
  const r = best.route;
  updateInfo(`Выбран маршрут: ${r.name}. Пешком к маршруту: ${(best.walkStart*1000).toFixed(0)} м, от маршрута до цели пешком: ${(best.walkEnd*1000).toFixed(0)} м. Длина участка по маршруту: ${(best.routeSegmentLen*1000).toFixed(0)} м.`);

  // Пешком от origin до nearestToOrigin
  const pStart = best.nearestToOrigin.geometry.coordinates; // [lng,lat]
  const pEnd = best.nearestToDest.geometry.coordinates;

  const walkTo = L.polyline([[origin[1],origin[0]],[pStart[1],pStart[0]]], {dashArray:'5,8', weight:3}).addTo(resultLayers);
  const walkFrom = L.polyline([[pEnd[1],pEnd[0]],[dest[1],dest[0]]], {dashArray:'5,8', weight:3}).addTo(resultLayers);

  // Полоска маршрута — точный отрезок между pStart и pEnd по линии маршрута
  // В leaflet у нас есть route._poly; но возьмём GeoJSON сегмент best.slice
  if (best.slice && best.slice.geometry && best.slice.geometry.coordinates.length>0) {
    const segLatLngs = best.slice.geometry.coordinates.map(c=>[c[1],c[0]]);
    L.polyline(segLatLngs, {color:r.color, weight:6}).addTo(resultLayers);
  } else {
    // fallback: нарисовать участок от pStart до pEnd прямой линией вдоль маршрута
    L.polyline([[pStart[1],pStart[0]],[pEnd[1],pEnd[0]]], {color:r.color, weight:6}).addTo(resultLayers);
  }

  // Покажем точки посадки/высадки
  L.circleMarker([pStart[1],pStart[0]], {radius:6, fill:true}).addTo(resultLayers).bindPopup('Садиться сюда');
  L.circleMarker([pEnd[1],pEnd[0]], {radius:6, fill:true}).addTo(resultLayers).bindPopup('Выходить здесь');

  // Немного визуального указания: выделим весь маршрут
  best.route._poly.setStyle({weight:3, opacity:0.25});

  // Рамка под результат
  map.fitBounds(resultLayers.getBounds().pad(1.1));
}

// --- Кнопки ---
document.getElementById('resetBtn').addEventListener('click', ()=>{
  origin=null; dest=null;
  if (originMarker) map.removeLayer(originMarker);
  if (destMarker) map.removeLayer(destMarker);
  originMarker=null; destMarker=null;
  resultLayers.clearLayers();
  ROUTES.forEach(r=> r._poly.setStyle({weight:4, opacity:0.7}));
  updateInfo('Сброшено. Кликни на карту, чтобы поставить своё местоположение.');
});

document.getElementById('fitBtn').addEventListener('click', ()=>{
  const group = L.featureGroup(ROUTES.map(r=>r._poly));
  map.fitBounds(group.getBounds().pad(0.5));
});

updateInfo('Кликни на карту, чтобы поставить своё местоположение.');

</script>
</body>
</html>
